'''
Mosquitto Broker Manager
Developed by Daniel Blake, 2025

Automatically performs the steps required to authenticate to clients and receive, negatiate, & store new client PSKs and Objects.

Built for Windows & Linux



Workflow;

Client Connects To Locally Hosted Broker
    |
    - Client Authenticates To Broker Using Methods Provided By Mosquitto
        |
        - Broker Manager Listens to Authentication Channel Through Mosquitto For HMAC Request or PSK Refresh Request (2 Minute Timeout) (Using Mosquitto Prevents Additional Computational Requirements)
            |
            - Client Sends HMAC Request With Client Identifier, Showing Client Has Successfully Authenticated To Broker
                |
                - Client Listens To Authentication Topic (2 Minute Timeout)
                |
                - Broker Manager Uses Client Identifer To Lookup Required PSK
                    |
                    - Broker Manager Calculates HMAC Using Listed Client PSK
                        |
                        - Broker Manager Responds With Calculated HMAC & Client Identifier Using Mosquitto
                            |
                            - Broker Manager Listens To Authentication Topic (2 Minute Timeout)
                            |
                            - Client Performs HMAC Calculation Using It's Own PSK & Compares
                                |
                                - If Client Detects Variance Client Publishes Failure Message
                                    |
                                    - Client Aborts Connection
                                    |
                                    - Client Logs Event & Notifies User Of Failed Connection
                                    |
                                    - Broker Manager Logs Event

            If Client Detects Expired PSK
            |
            - Broker Manager Listens To Authentication Chennel Through Mosquitto For HMAC Request Or PSK Refresh Request (2 Minute Timeout)
                |
                - Client Sends PSK Refresh Request & Client Identifier
                    |
                    - Broker Receives Request & Creates A Specific PSK Refresh Topic Using A Predetermined Naming Convention
                        |
                        - Broker Listens To Newly Created PSK Refresh Topic (2 Minute Timeout)
                    |
                    - Client Subscribes To Newly Created PSK Refresh Topic & Publishes Client Identifier To Topic
                        |
                        - Client Awaits Broker Response (2 Minute Timeout)
                        |
                        - Both Client & Broker Lookup Backup PSK
                            |
                            - Broker Manager Uses Backup PSK To Generate HMAC
                                |
                                - Broker Manager Publishes HMAC
                                    |
                                    - Broker Listens To Client's PSK Refresh Topic (2 Minute Timeout)
                                    |
                                    - Client Performs Local Calculation & Compares
                                        |
                                        - Client Aborts Connection If Variance Detected
                                        |
                                        - Client Generates A New PSK & Publishes To Authentication Channel
                                            |
                                            - Client & Broker Manager Replace Primary PSK With Newly Generated PSK (Stored As Temporary Variable)
                                            |
                                            - Client & Broker Manager Forget Backup PSK Values
                                                |
                                                - Client Sends HMAC Request With Client Identifier
                                                    |
                                                    - Client Listens To Authentication Channel (2 Minute Timeout)
                                                    |
                                                    - Broker Manager Receives HMAC Request & Calulates HMAC With New PSK
                                                        |
                                                        - Broker Manager Responds With Calculated HMAC
                                                        |
                                                        - Broker Manager Listens To PSK Refresh Topic (2 Minute Timeout)
                                                            |
                                                            - Client Performs Local Calculation & Compares
                                                                |
                                                                - Broker Listens On PSK Refresh Topic (2 Minute Timeout)
                                                                    |
                                                                    - Broker Discards New PSK If Success Message Not Received
                                                                    |
                                                                    - Broker Discard New PSK Message If Failure Message Received
                                                                |
                                                                - Client Sends Failure Message If Variance Detected
                                                                    |
                                                                    - Client Aborts Connection, Notifies User, & Logs Event
                                                                    |
                                                                    - Broker Discards Newly Generated PSK & Logs Event
                                                                |
                                                                - Client Sends Success Message If Variance Not Detected
                                                                    |
                                                                    - Both Client & Broker Write New PSK To Disk & Logs Event
                                                                        |
                                                                        - Client Notifies User Of Successful PSK Generation & Pending Connection Restart
                                                                        |
                                                                        - Client Restarts Connection And Uses New PSK To Authenticate

    '''